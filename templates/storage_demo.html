<!DOCTYPE html>
<html>
<head>
    <title>LocalStorage Management Demo</title>
    <style>
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: #1a1a19;
            color: #e2e2e0;
            padding: 40px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .container {
            background: #0e0e0d;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        h1 { color: #26D086; }
        h2 { color: #4FE0A3; margin-top: 30px; }
        
        button {
            background: #26D086;
            color: #0e0e0d;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-weight: 600;
        }
        button:hover { background: #1BA66A; }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .info-card {
            background: #1a1a19;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
        }
        .info-card h3 {
            color: #26D086;
            margin: 0 0 10px 0;
            font-size: 14px;
            text-transform: uppercase;
        }
        .info-value {
            font-size: 24px;
            font-weight: 600;
        }
        
        #log {
            background: #050505;
            padding: 20px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #333;
        }
        .log-time { color: #666; }
        .log-action { color: #26D086; }
        .log-reason { color: #4FE0A3; }
        
        .storage-items {
            margin: 20px 0;
        }
        .storage-item {
            background: #1a1a19;
            padding: 10px;
            margin: 5px 0;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .item-key { color: #26D086; font-weight: 600; }
        .item-size { color: #999; font-size: 12px; }
        
        .warning { 
            background: #ff6b6b22; 
            border: 1px solid #ff6b6b; 
            color: #ff6b6b;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
    <script src="{{ url_for('static', filename='localStorage_management.js') }}"></script>
</head>
<body>
    <h1>üóÑÔ∏è LocalStorage Management System</h1>
    
    <div class="container">
        <h2>Storage Information</h2>
        <div class="info-grid">
            <div class="info-card">
                <h3>Total Size</h3>
                <div class="info-value" id="totalSize">0 MB</div>
            </div>
            <div class="info-card">
                <h3>Items Stored</h3>
                <div class="info-value" id="itemCount">0</div>
            </div>
            <div class="info-card">
                <h3>Data Age</h3>
                <div class="info-value" id="dataAge">N/A</div>
            </div>
            <div class="info-card">
                <h3>Cache Version</h3>
                <div class="info-value" id="cacheVersion">N/A</div>
            </div>
        </div>
        
        <h2>Actions</h2>
        <div>
            <button onclick="simulateStoreData()">Simulate Store Analysis Data</button>
            <button onclick="checkFreshness()">Check Data Freshness</button>
            <button onclick="simulateOldData()">Simulate Old Data (Expired)</button>
            <button onclick="clearAnalysisOnly()">Clear Analysis Data</button>
            <button onclick="clearAll()">Clear All Storage</button>
            <button onclick="refreshInfo()">Refresh Info</button>
        </div>
    </div>
    
    <div class="container">
        <h2>Stored Items</h2>
        <div id="storageItems" class="storage-items"></div>
    </div>
    
    <div class="container">
        <h2>Activity Log</h2>
        <div id="log"></div>
    </div>
    
    <div class="container">
        <h2>Automatic Triggers</h2>
        <div class="warning">
            <strong>‚ö†Ô∏è Active Triggers:</strong>
            <ul>
                <li>‚úÖ Version mismatch detection (current: 1.0.2)</li>
                <li>‚úÖ Data age check (expires after 24 hours)</li>
                <li>‚úÖ Structure validation (checks for required fields)</li>
                <li>‚úÖ API error handling (clears on NO_DATA errors)</li>
                <li>‚úÖ Storage quota management (auto-clears when full)</li>
            </ul>
        </div>
    </div>

    <script>
        const storageManager = new LocalStorageManager();
        const log = document.getElementById('log');
        
        function addLog(action, details = '') {
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `
                <span class="log-time">[${time}]</span>
                <span class="log-action">${action}</span>
                ${details ? `<span class="log-reason"> - ${details}</span>` : ''}
            `;
            log.insertBefore(entry, log.firstChild);
        }
        
        function refreshInfo() {
            const info = storageManager.getStorageInfo();
            document.getElementById('totalSize').textContent = `${info.totalSizeMB} MB`;
            document.getElementById('itemCount').textContent = info.itemCount;
            
            // Check data age
            const timestamp = localStorage.getItem('cache_timestamp');
            if (timestamp) {
                const age = Date.now() - parseInt(timestamp);
                const hours = Math.round(age / 1000 / 60 / 60);
                document.getElementById('dataAge').textContent = `${hours} hours`;
            } else {
                document.getElementById('dataAge').textContent = 'N/A';
            }
            
            // Show version
            const version = localStorage.getItem('cache_version');
            document.getElementById('cacheVersion').textContent = version || 'N/A';
            
            // Show stored items
            const itemsDiv = document.getElementById('storageItems');
            itemsDiv.innerHTML = '';
            
            info.largestItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'storage-item';
                div.innerHTML = `
                    <span class="item-key">${item.key}</span>
                    <span class="item-size">${item.sizeMB} MB</span>
                `;
                itemsDiv.appendChild(div);
            });
            
            addLog('Info refreshed', `${info.itemCount} items, ${info.totalSizeMB} MB total`);
        }
        
        function simulateStoreData() {
            const mockData = {
                success: true,
                analysis_id: 'test_123',
                projections: Array(5).fill(null).map((_, i) => ({
                    property_id: `prop_${i+1}`,
                    annual_total: 120000 + (i * 10000),
                    monthly_projections: {}
                })),
                monthly_expectations: {
                    '1': { revenue: { expected: 8000 }, occupancy: { expected: 65 }, data_quality: { included_count: 5 } },
                    '2': { revenue: { expected: 7500 }, occupancy: { expected: 60 }, data_quality: { included_count: 5 } }
                }
            };
            
            const saved = storageManager.saveData('analysis_results', mockData);
            if (saved) {
                addLog('Data stored', 'Mock analysis data saved successfully');
            } else {
                addLog('Storage failed', 'Could not save data');
            }
            refreshInfo();
        }
        
        function checkFreshness() {
            const data = storageManager.getData('analysis_results', 24);
            if (data) {
                addLog('Data is fresh', 'Within 24-hour window');
            } else {
                addLog('Data expired or missing', 'Needs refresh');
            }
        }
        
        function simulateOldData() {
            // Store data with old timestamp
            const oldTimestamp = Date.now() - (25 * 60 * 60 * 1000); // 25 hours ago
            localStorage.setItem('cache_timestamp', oldTimestamp.toString());
            addLog('Simulated old data', 'Timestamp set to 25 hours ago');
            refreshInfo();
        }
        
        function clearAnalysisOnly() {
            storageManager.clearAnalysisData('demo_clear');
            addLog('Cleared analysis data', 'Only analysis_results removed');
            refreshInfo();
        }
        
        function clearAll() {
            storageManager.clearAllStorage('demo_clear_all');
            addLog('Cleared all storage', 'All data removed except preferences');
            refreshInfo();
        }
        
        // Check clearance log
        const clearanceLog = localStorage.getItem('clearance_log');
        if (clearanceLog) {
            try {
                const log = JSON.parse(clearanceLog);
                if (log.length > 0) {
                    addLog('Previous clearances', `${log.length} recorded`);
                }
            } catch (e) {}
        }
        
        // Initial load
        refreshInfo();
        addLog('Page loaded', 'Storage manager initialized');
    </script>
</body>
</html>